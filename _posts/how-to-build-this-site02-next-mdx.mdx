---
title: "How do I build this site 02 - Next.js & MDX"
date: 'January 18, 2022'
description: 'I would like to be a the enthusiasm and professional engineer. Keep learning and willing to share to improve myself, so I start to write some blogs about what I learned or something interesting.'
thumbnailUrl: '/assets/blog/how-to-build-this-site02-next-mdx/how-to-build-this-site02-next-mdx.svg'
tags: ['blog', 'javascript', 'Next.js']
---

## What are Next.js & MDX

### Next.js
Next.js is a open-sourced and React-based framework. We can create SSR and SGR app easiily, and it also support ISR with [SWR](https://www.npmjs.com/package/swr) library.
There are completed documents and many [examples](https://nextjs.org/examples) for we to learn Next.js, one of the case is using MDX/MD on Next.js.

### MDX
MDX allow we use JSX in the markdown content. There are plugins provide a good integration on it, we can use custom components or override the markdown sytnx with wer components.
It's a straightforward way for me writing blog and with less burdensome on maintenance. That's the reason I decide to use MDX. 

## How to start?

Next.js provides a CLI tool enable we to quickliy start building a new Next.js application, we don't need to set up everything by werself.
I use npm in my case showing.

```
npx create-next-app@latest
```
I would like to use typescript, the CLI tool also provides `--ts` or `--typescript` flag.

```
npx create-next-app@latest --ts
```
After enter this command line, we need to enter `y` and wer project name.
<img src="/assets/blog/how-to-build-this-site02-next-mdx/setup-option-in-nextjs.png"  alt="set up in next.js app" width="60%"/>
<br/>

Then, it will install dependency packages. After install completed, there are the successful information and some scripts tip to start running project.

<img src="/assets/blog/how-to-build-this-site02-next-mdx/setup-finished-in-nextjs.png"  alt="next.js install completed" width="60%"/>
<br/>

Enter the command line, `npm run dev`, and open link `http://localhost:3000` to see the Next.js app running.

<img src="/assets/blog/how-to-build-this-site02-next-mdx/setup-initial-nextjs.png"  alt="Run the Next.js app" width="80%"/>
<br/>

There `.next` directory is generated with `npm run dev`, there are cache, server, and static files of our app.


## Pages and routing

In Next.js, all the site pages rendered by the files under `pages` directory, there are multiple page name rules to map the router.<br/>
I need pages one of is to list all posts and the other is the content of every post. I create a folder named `blog`, and then create `index.tsx` to list posts and `[slug].tsx` about post content.
The directory as shown below, the default file under `blog` is `index.tsx`. When we run local, the address in blog page is `http:localhost:3000/blog`.
The `[slug].tsx` is a way to map dynamic path name, the address is `http:localhost:3000/blog/[dynamic-path-name]`.
<br/>
<img src="/assets/blog/how-to-build-this-site02-next-mdx/blog-in-pages.png"  alt="The directory of pages" width="40%"/>
<br/>

And create `_posts` folder to place all post write by mdx, and there two mdx file as posts.

<br/>
<img src="/assets/blog/how-to-build-this-site02-next-mdx/create-_posts-directory.png"  alt="The directory of pages" width="60%"/>
<br/>

## How to write MDX
Here's the content what MDX look like, we can use markdown with html tag, and jsx.

```md
---
title: "How do I build this site 01 - introduction"
date: 'January 18, 2022'
description: 'I would like to be a the enthusiasm ...'
thumbnailUrl: '/assets/blog/how-to-build-this-site/how-to-build-this-site.jpeg'
tags: ['blog', 'javascript', 'Next.js']
---

## The motivation

I would like to be a the enthusiasm and professional engineer.
Keep learning and willing to share to improve myself, 
so I start to write some blogs about what I learned or something interesting.

...

#### Blog and Posts
<img src="/assets/blog/how-to-build-this-site/wireframe-blog.jpg"  alt="Wireframe home" width="100%"/>
<br/>

...

### Use these to improve development
* [eslint](https://eslint.org/)
* [prettier](https://prettier.io/)
* [typescript](https://www.typescriptlang.org/)
* [husky](https://typicode.github.io/husky/#/)

<PostThumbnail
  slug="demo"
  thumbnailUrl="demo.png"
  title="demo title"
  date="'January 18, 2022'"
  description="demo description"
/>

...
```
On the top of content enclosed with `---`, it's a post metadata used YAML sytnx. The sytnx use key and value type to write any information.
The `<PostThumbnail>` is the custom components to link other post. There's a demo as show below:
<PostThumbnail
  slug="how-to-build-this-site"
  thumbnailUrl="/assets/blog/how-to-build-this-site/how-to-build-this-site.jpeg"
  title="How do I build this site 01 - introduction"
  date="January 18, 2022"
  description="I would like to be a the enthusiasm and professional engineer. Keep learning and willing to share to "
/>

## Building blog page

There're two things we need to do, one is list all posts in `index.tsx`, the other one is show MDX content in `[slug].tsx`.

### Next.js page and fetch data

#### In Next.js page
In Next.js, we can use a `getStaticProp` method to fetch data which is run at build time, and return some data, like props data used in page.
As shown below, the basic code look like this:

```javascript
const Blog: NextPage<Props>= (props: Props) => {{
  return (
    <div></div>
  )
}
export const getStaticProps = async () => {
  return {
    props: {
      // props data
    }
  }
}
export default Blog
```
But if we need post list in pagination by query parameter, like `http://localhost:3000/blog?page=1`, we could not get the query in `getStaticProp`. Because it's only invoke on a build time, and not refresh data when queries are changed.

Next.js provide other method is `GetServerSideProps`, it's primarily used to fetch data for every time when user with different request, like query paramters are changed.
This method is used like `getStaticProp`, but we can know the query from user request.

```javascript
export const getServerSideProps: GetServerSideProps = async ({ query }) => {
  // We can use query for data fetching
  return {
    props: {
      // props data
    },
  };
};
```

#### Fetch data from _posts folder

To fetch data, we need to read all MDX files from `_post` directory. I would like to use an API to fetch data, so create `lib` directory, and then create `api.tsx` under `lib`.

Before fetching data, we need install the `gray-matter` to get metadata from MDX file.

```
npm install -D gray-matter
```

In `api.tsx`, the first thing is to import `fs`, `path`, and `gray-matter`.

```javascript
// api.tsx
import fs from 'fs'
import path from 'path'
import matter from 'gray-matter'
```

Next, write a method to get metadata from all posts. Use `fs.readdirSync` to get files name array in `_posts` folder, map file name as path and get metatdata by `gray-matter`.

```javascript
// api.tsx
...
const postsDirectory = path.join('_posts');

const readFile = (fileName: string) => {
  const postPath = join(postsDirectory, fileName);
  return fs.readFileSync(postPath, 'utf-8');
};

export const getAllPosts = () => {
  const files = fs.readdirSync(postsDirectory);
  const posts = files.map((fileName) => {
    const markdownWithMeta = readFile(fileName);
    const { data: metaData } = matter(markdownWithMeta);
    return {
      metaData,
      slug: fileName.split('.')[0],
    };
  });
  return posts;
};
```
Next, we can use `getAllPosts` api to fetch data in `blog/index.tsx`. In the Blog components, we use posts as our prop to render them on blog page.
Let's add thumbnail, title and description in every post block, and also use Link component in 'next/link' to link post.

```javascript
// index.tsx
import { getAllPosts } from '../../lib/api';
import Link from 'next/link'

const Blog: NextPage<Props>= (props: Props) => {{
  return (
    <>
      {
        posts.map((post, index) => <div>
          <img url={post.metaData.thumbnailUrl}/>
          <h2>{post.metaData.title}</h2>
          <p>{post.metaData.description}</p>
          <Link href={`/blog/${post.slug}`}>
            <a>Read more...</a>
          </Link>
        </div> )
      }
    </>
  )
}
export const getStaticProps = async () => {
  const posts = getAllPosts();
  return {
    props: {
      posts
    }
  }
}
```
In `slug.tsx`, it will generate all path list at build time use by `getStaticPaths`.

```javascript
// [slug].tsx
export const getStaticPaths = () => {
  const posts = getAllPosts();
  const paths = posts.map((post) => {
    return {
      params: {
        slug: post.slug,
      },
    };
  });
  return {
    paths,
    fallback: false,
  };
};
```

### Set MDX in [slug].tsx page

In the beginning, we need to install `next-mdx-remote` which support to add MDX in Next.js app. 
There is a method called `serialize` in `next-mdx-remote`, it parse and compile the MDX string thus rendered on page.

```
npm install -D next-mdx-remote
```

We also need fetch post content in `getStaticProps`, and use it as our [slug].tsx prop.

```javascript
// [slug].tsx
import fs from 'fs'
import path from 'path'
import matter from 'gray-matter'
import matter from 'gray-matter'

export const getStaticProps = async ({ params: { slug } }: Params) => {
  const { metaData, content } = fs.readFileSync(path.join('_posts', slug + '.mdx'), 'utf-8')
  const { data: frontMatter, content } = matter(markdownWithMeta)
  const { mdxSource } = await serialize(content);

  return {
    props: {
      mdxSource,
    },
  };
};
```

After that, we import `MDXRemote` from `next-mdx-remote`, and use the <MDXRemote/> to render mdx content. 
Not only the mdx source, we could set our custom components in the `components` prop.
I use `<PostThumbnail>` as my example.

```javascript
// [slug].tsx
...
import { PostThumbnail } from '../../components';

const markdownComponents = {PostThumbnail}
const Post = ({ mdxSource, prevPost, nextPost }: Props) => (
  <MDXRemote {...mdxSource} components={markdownComponents}/>
)
...
export default Post;
```
